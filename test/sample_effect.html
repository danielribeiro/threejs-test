<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ThreeJS Unit Tests - Using build/Three.js</title>
    <link rel="stylesheet" href="qunit-1.10.0.css">
</head>
<body>
<style>
    img {
        display: block;
    }

    .slider {
        width: 300px;
    }

    .content {
        position: absolute;
    }

    .fail {
        z-index: 500;
        position: absolute;
    }

    .original {
        position: absolute;
    }
    #fixture {
        display: none;
    }
</style>

<!-- add sources to test below -->

<script src="../vendor/rng.js"></script>
<script src="../vendor/three.js"></script>
<script src="../vendor/Mirror.js"></script>
<script src="../vendor/resemble.js"></script>
<script src="../vendor/ColladaLoader.js"></script>
<script src="mirror_sample.js"></script>
<script src="collada_sample.js"></script>
<script src="geometries_sample.js"></script>


<div id="fixture">
    <img class="original" src="fixtures/collada.png">
    <img class="fail" src="fail.png">
</div>

<script>
    function ComparerWidget(container, original, fail) {
        this.wrapper = this.setupDom(container, original, fail)
        this.min = 0;
        this.max = 10;
        this.step = 12;
        this.reanimateDelta = 3000;
        this.lastInteraction = null;
        this.v = this.min; // TODO: refactor this
        this.inp = this.wrapper.getElementsByClassName("slider")[0]
        this.failImg = fail
        this.clock = new THREE.Clock()
    }

    ComparerWidget.prototype.setupDom = function (container, original, fail) {
        original.setAttribute("class", "original")
        fail.setAttribute("class", "fail")
        var wrapper = document.createElement("div")
        wrapper.innerHTML = '<div id="wrapper">Expected ' +
                '<input class="slider" type="range" name="points" min="0" max="10" step="0.01"> Actual' +
                '<div class="content"></div></div>'
        container.appendChild(wrapper);
        var content = wrapper.getElementsByClassName("content")[0]
        content.appendChild(original)
        content.appendChild(fail)
        return wrapper;
    }

    ComparerWidget.prototype.animate = function() {
        this.clock.getDelta()
        this.innerAnimate()
    };

    ComparerWidget.prototype.innerAnimate = function() {
        var delta = this.clock.getDelta()
        requestAnimationFrame(this.innerAnimate.bind(this))
        if (this.lastInteraction && new Date() - this.lastInteraction > this.reanimateDelta) {
            this.paused = false
        }
        if (this.paused) return
        this.updateOpacity(delta)
    }


    ComparerWidget.prototype.updateOpacity = function(delta) {
        this.v += this.step * delta
        if (this.v > this.max) {
            this.v = this.max
            this.step = -this.step
        }
        if (this.v < this.min) {
            this.v = this.min
            this.step = -this.step
        }
        this.inp.value = this.v
        this.setOpacity(this.v)
    }

    ComparerWidget.prototype.setOpacity = function(v) {
        this.failImg.style.opacity = v / this.max
    }

    ComparerWidget.prototype.setup = function() {
        var self = this;
        this.inp.addEventListener('click', function() {
            self.paused = true
            self.setOpacity(self.inp.value)
        })
        this.inp.addEventListener('change', function() {
            self.setOpacity(self.inp.value)
            self.lastInteraction = new Date()
        })
        this.animate()
    }
    var fix = document.getElementById("fixture")
    var original = fix.getElementsByClassName("original")[0]
    var fail = fix.getElementsByClassName("fail")[0]
    new ComparerWidget(document.body, original, fail).setup();


</script>


</body>
</html>
